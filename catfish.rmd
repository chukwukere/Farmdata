---
title: "Catfish Farm"
author: "Chukwukere uhuegbulem"
date: "02/02/2021"
output: html_document
---
# Project Description
This is a voluntary project conducted for a catfish farm in Abuja. The objective of the project was: <br>
1. To present the list of debtors and how much they owe the catfish farm. <br>
2. To analyze the data from the farm for useful insights for growth.

The data used was the sales record of the fish farm in excel format. The workbook contained 56 sheets detailing sales from different days. Each sheet contained the names of the buyer, the different types of fishes sold by the farm, the weight of the fishes in grams, the amount per gram for each fish, the total quantity of fish purchased by each buyer, the amount paid by the buyer, the balance unpaid (if applicable), and the balance owed by the farm (if applicable). 

## Process description
1. The sales data was read into a list in R, with each sheet in the workbook converted to a data frame in the list <br>
2. A function was written (Farmdebtors function) to clean, group, arrange and filter the data. The output of the function was a data frame of four columns: name of debtor, amount due, amount paid, and balance unpaid. <br>
3. The list was written back to an excel workbook and sent to the client. Unfortunately, due to data protection regulations, the list can not be displayed in this write-up.<br>
4. Another function was written(Farm analytics function) to prepare the data for visualization and analysis.  <br>
5. visualization was achieved using the ggplot2 library. The goal of visualizing the data was to understand the following: <br>
  A. what fish types sold the most and the least? <br>
  B. what days of the week were best for sales (this was useful in planning staff work schedule)?  <br>
  C. was fish sales influenced by any event during the year?

## Result summary
Insight 1: Fish types labeled “s” and “ss” in the sales records had the most sales on the farm. Approximately 61 % of all fish sold throughout the year from the fish farm were “s” (30.3 %) and “ss” (30.2 %). Meanwhile, negligible quantities of PRE-BROOD and BROODSTOCK fish was sold all year. 

Insight 2: It was discovered that Mondays were the best days for sales. 76 % of all sales were made on a Monday. No sale was done on Tuesdays and Wednesdays. It should be noted that the cause of this trend can not be explained from the data set made available for this project. Future projects might consider looking further into this trend. 

Insight 3: It can not be concluded from the data that any of the nationwide holidays in Nigeria, had any impact on the sales of fish. Future projects can look into the effect of other factors 

## R Libraries 
The following R libraries were used for this project: <br>
1. tidyverse <br>
2. readxl <br>
3. dplyr <br>
4. reshape2 <br>
5. ggplot2 <br>
6. shiny <br>
7. plotly <br>
8. scales 
```{r load the r libraries, include=FALSE}
library(tidyverse)
library(readxl)
library(dplyr)
library(reshape2)
library(ggplot2)
library(shiny)
library(plotly)
library(scales)
```
```{r Import the data , include=FALSE}
excel_sheets("C:/Users/ceuhu/Downloads/CAT FISH SALES SCHEDULE.xlsx") %>% 
  map(~read_excel("C:/Users/ceuhu/Downloads/CAT FISH SALES SCHEDULE.xlsx",.))->catfish_schedule
```
```{r write the Farm debtors function, include=FALSE}
farm.debtors <- function(x,name_of_column){
  arg1<-paste(name_of_column)
  arg2<- paste(x)
  as.data.frame(x)-> quick
  quick[1:nrow(quick),1]->temp 
  quick[1]<- as.character(quick[1]) 
  quick[1,c(1:3,length(quick)-c(6,5,2:0))]<-colnames(quick[1,c(1:3,length(quick)-c(6,5,2:0))])
  quick[1,c(length(quick)-c(4,3))]<- c("CASH(N)","BANK(N)") 
  colnames(quick)<- quick[1,] 
  quick$DATE <- as.POSIXct(temp, origin="1960-01-01") 
  quick<- quick[-1,]
    quick$`CASH(N)`[is.na(quick$`CASH(N)`)]<- as.numeric(0);quick$`BANK(N)`[is.na(quick$`BANK(N)`)]<- as.numeric(0);quick$AMOUNT.DUE...U.20A6..[is.na(quick$AMOUNT.DUE...U.20A6..)]<- as.numeric(0)
 quick%>% select(DATE,NAME, starts_with(c(arg1))) %>% 
    rename(c("Amount.Due"="AMOUNT.DUE...U.20A6.."))%>% 
    mutate(Balance=as.numeric(.$Amount.Due) -(as.numeric(.$`CASH(N)`) + as.numeric(.$`BANK(N)`)))-> quick2 
}
```
```{r calling the farm debtors function, include=FALSE}
y1<-as.data.frame(c())
for(i in 1:length(catfish_schedule)){y<- farm.debtors(catfish_schedule[i],c("Amount.due","cash","bank","Total"))
if(is_empty(y1)==T){y1<-y}else{y1<-bind_rows(y1,y)}
}
```
```{r Arranging and filtering the data, include=FALSE}
na.omit(y1$NAME)-> u; a<-c("TOTAL","RETAIL"); u[!u %in% a]-> u 
subset.data.frame(y1,NAME %in% u)%>% .[order(.$NAME,.$Balance),]%>%filter(Balance>=0) ->p
p$Amount.Due <- as.numeric(p$Amount.Due);p$Balance<- as.numeric(p$Balance);p$`CASH(N)`<- as.numeric(p$`CASH(N)`);p$`BANK(N)`<- as.numeric(p$`BANK(N)`)
p%>% group_by(NAME)%>% summarise_at(c("Amount.Due","BANK(N)","CASH(N)","Balance"),sum)->d
```
```{r writing the farm analytic function, include=FALSE}
farm.Analytics <- function(x,name_of_column){
  arg1<-paste(name_of_column)
  arg2<- paste(x)
  as.data.frame(x)-> quick
  quick[1:nrow(quick),1]->temp 
  quick[1]<- as.character(quick[1]) 
  quick[1,c(1:3,length(quick)-c(6,5,2:0))]<-colnames(quick[1,c(1:3,length(quick)-c(6,5,2:0))])
  quick[1,c(length(quick)-c(4,3))]<- c("CASH(N)","BANK(N)") 
  colnames(quick)<- quick[1,] 
  quick$DATE <- as.POSIXct(temp, origin="1960-01-01") 
  quick<- quick[-1,]
    quick$`CASH(N)`[is.na(quick$`CASH(N)`)]<- as.numeric(0);quick$`BANK(N)`[is.na(quick$`BANK(N)`)]<- as.numeric(0);quick$AMOUNT.DUE...U.20A6..[is.na(quick$AMOUNT.DUE...U.20A6..)]<- as.numeric(0)
c<- c() 
  Name_of_quick <- names(quick)
  for(i in 1:c(length(Name_of_quick)-6)){
    if(startsWith(Name_of_quick[i],"AMOUNT")==T)
    {c<- paste("Amount",names(quick[i-2]),sep = "_");Name_of_quick[i]<- c}}
    colnames(quick)<- Name_of_quick
 quick%>% subset.data.frame(.,!duplicated(.))%>% select(DATE,NAME, starts_with(c(arg1))) %>%
    rename(c("Amount.Due"="AMOUNT.DUE...U.20A6.."))-> sharp
}
```
```{r calling the farm analytics function, include=FALSE}
container1<-as.data.frame(c())
for(i in 1:length(catfish_schedule)){tempcont<- farm.Analytics(catfish_schedule[i],c("Amount","B","c","Brood","s","pre", "dry","weak"))
if(is_empty(container1)==T){container1<-tempcont}else{container1<-bind_rows(container1,tempcont)}
}
```
```{r cleaning the data and converting non-numeric columns, include=FALSE}
a<-c("TOTAL",NA)
select(container1, !starts_with(c("Amount_size","size","cash","Bank","Amount.Due")))%>% 
  subset.data.frame(.,!NAME %in% a)-> clean_data
for(i in 3:length(clean_data)){clean_data[,i]<-as.numeric(clean_data[,i]);
clean_data[,i][is.na(clean_data[,i])]<-as.numeric(0)}
```
## Insights 1
*what fish sells the most and the least?*
```{r fish sales in grams, include=FALSE}
reorg<- melt(clean_data,id=c("DATE","NAME","Amount_B.","Amount_S","Amount_SS","Amount_BROODSTOCK","Amount_DRY",
                             "Amount_WEAK","Amount_TINY/DEAD","Amount_TINY","Amount_DEAD","Amount_TINY/DEAD.1",
                             "Amount_PRE-BROOD","Amount_DRY/WEAK"))
reorg%>% group_by(variable)%>% summarise_at("value",sum)%>% 
  mutate(percent_sales=round((value/sum(value))*100,digit=2))->summ1
ggplot(summ1,aes(x=value,y=variable,fill=variable,text= paste("Fish type: ",variable,"\n",
                                                              "Total grams sold: ",value,"\n",
                                                              "% of total sales: ",percent_sales,sep = ""))) +
  geom_col()+ 
  labs(title = "Cat-fish sales distibution by weight from March - Nov 2020",
       subtitle = "what fish had the highest and least sales?",
       x= "Weight of fish purchased (gram)",
       y= "Type of fish",
       fill= "Type of fish") +
  scale_x_continuous(limits = c(0,55000))+
  theme_bw() -> fish_distribution
```
PLOT 1
```{r Fish sales in grams, echo=FALSE}
 ggplotly(fish_distribution,tooltip = "text")
```
## Insights 2
*what days of the week had the most fish sales?*
```{r Fiah sales by day, include=FALSE}
clean_data %>% mutate(weekday = weekdays.POSIXt(clean_data$DATE))%>% .[,-c(1,2)]%>% 
  group_by(weekday)%>% summarise_all(sum)%>% .[-length(.$weekday),]%>% 
  melt(.,id=c("B.","S","SS","BROODSTOCK","DRY","weekday",
              "WEAK","Amount_TINY/DEAD","Amount_TINY","Amount_TINY/DEAD.1","Amount_DEAD",
              "PRE-BROOD","DRY/WEAK"))%>% 
  mutate(percent_sales1=round((value/sum(value))*100,digit=2))->summ2
options(scipen=999)
ggplot(summ2, aes(text= paste("Fish type: ",variable,"\n",
                              "Sales in Naira: ",value,"\n",
                              "Day of the week:",weekday,"\n",
                              "% sales: ",percent_sales1,sep = "")))+
  geom_col(aes(x=value,y=variable, fill=weekday))+
  labs(title = "Fish sales across the days of the week",
       subtitle = "what days of the week is best for sales",
       x= "Revenue from fish sales",
       y= "Types of fish ",
       fill = "Days of the week")+
  scale_x_continuous(labels = comma)+
  theme_bw()+ theme(axis.text.x = element_text(angle = 90)) -> Fish_sales_by_day
 
```
Plot 2
```{r fish sales by day, echo=FALSE}
ggplotly(Fish_sales_by_day,tooltip = "text")
```
## Insights 3
 _what was the revenue generation across the year, and was it affected by yearly events?_
```{r revenue across year, include=FALSE}
subset.data.frame(y1,!NAME %in% a)%>% select(starts_with(c("DATE","TOTAL","Amount")))->interim
 
for(i in 2:3){interim[,i]<-as.numeric(interim[,i]);
interim[,i][is.na(interim[,i])]<-as.numeric(0)} 
interim %>% group_by(DATE)%>% summarise_at(c("Amount.Due","TOTAL.QTY.SOLD"),sum)%>%
  filter(.,DATE > "2018-01-01 12:13:17")%>%
  mutate(month = months.POSIXt(.$DATE),weekday = weekdays.POSIXt(.$DATE))-> summ3 # I just chose any date greater than 1960 to filter out the origin date
sharp_slect <- filter(summ3,Amount.Due > 3000000); 
sharp_slect2<- filter(summ3,Amount.Due < 2000000)
ggplot(summ3)+ geom_point(aes(x=DATE,y=Amount.Due),size=2,color="gold") + 
  geom_line(aes(x=DATE,y=Amount.Due),size=1,color="black",alpha=0.3)+
  geom_point(data = sharp_slect, aes(x=DATE,y=Amount.Due),color="dark green",size=2) + 
  geom_point(data = sharp_slect2, aes(x=DATE,y=Amount.Due),color=" red",size=2)+
  geom_vline(xintercept = as.POSIXct(c("2020-03-01","2020-04-06","2020-05-18","2020-06-14", "2020-07-24","2020-09-24"),origin = "1960-01-01"),
             color=c("blue","purple","yellow","pink", "brown","green"), lwd= 2,alpha=c(0.2,0.5,0.5,0.5,0.5,0.5)) +
  labs(title = "Cat fish revenue distribution across the year",
       subtitle = "Did holiday's affect sales?",
       y = "Revenue from cat fish sales",
       x= "Date",
       caption= "PS: Holiday's appear one week before the actual dates") + 
  lims(y=c(500000,4500000))+
  geom_text(aes(x=as.POSIXct(c("2020-03-01"),origin= "1960-01-01"),y=2000000,
                label= "Womens's Day",angle= 90),size=2.8,vjust=-1)+
  geom_text(aes(x=as.POSIXct(c("2020-04-06"),origin= "1960-01-01"),y=3000000,
                label= "Easter",angle= 90),size=2.8,vjust=-1)+
  geom_text(aes(x=as.POSIXct(c("2020-05-18"),origin= "1960-01-01"),y=2500000,
                label= "Id el Filtr",angle= 90),size=2.8,vjust=-1)+
  geom_text(aes(x=as.POSIXct(c("2020-06-14"),origin= "1960-01-01"),y=2500000,
                label= "father's Day",angle= 90),size=2.8,vjust=-1)+
  geom_text(aes(x=as.POSIXct(c("2020-07-24"),origin= "1960-01-01"),y=3000000,
                label= "Id el Kabir",angle= 90),size=2.8,vjust=-1)+
  geom_text(aes(x=as.POSIXct(c("2020-09-24"),origin= "1960-01-01"),y=2000000,
                label= "Independence Day",angle= 90),size=2.8,vjust=-1)+
  theme_dark()+theme(panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     panel.grid.minor.x = element_line(color = "grey"),
                     panel.border = element_rect(fill = NA,colour = "black",size = 1),
                     panel.background = element_rect(fill = "white"))-> Revenue_across_year
```
Plot 3
```{r Revenue across year, echo=FALSE, message=FALSE, warning=FALSE}
Revenue_across_year
```